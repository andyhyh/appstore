<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Appstore</title>
  </head>

  <body>
    <div>
      <h2>{{ .NewestVersion.Chart.Name }}</h2>
      <p>{{ .NewestVersion.Chart.Description }}</p>
    </div>
    <div>
      <h3> Values: </h3>
      <form id="installationForm">
        Version:<br>
         <select name="version">
           {{ range .OtherVersions }}
           <option value="{{ .Chart.Version }}">{{ .Chart.Version }}</option>
           {{ end }}
        </select> 
        <input type="submit" name="submit" value="Install">
        <p id="installStatus"></p>
        <p id="releaseName"></p>
        <pre><p id="installStatusDetails"></p></pre>
      </form> 
    </div>
  </body>
  <script>

function installPackage(event) {
  event.preventDefault();
  var form = document.getElementById("installationForm");
  var versionsSelector = form.elements["version"];
  var version = versionsSelector.options[versionsSelector.selectedIndex].value
  var xhr = new XMLHttpRequest();
  var data = JSON.stringify({
    "version": version,
  }); 
  xhr.open('POST', "/api/v1/packages/install/" + packageName);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.onload = function() {
    if (xhr.status === 200) {
      var res = JSON.parse(xhr.responseText);
      var releaseName = document.getElementById('releaseName');
      var statusText = document.getElementById('installStatus');
      var statusTextDetails = document.getElementById('installStatusDetails');
      var details = res.info.status.resources;
      statusText.innerHTML = "The package was successfully installed!";
      statusTextDetails.innerHTML = details;
      releaseName.innerHTML = "Release name: " + res.name;
    } else {
      statusText.innerHTML = "The package was not successfully installed!";
    }
  };
  xhr.send(data);
}

var packageName = "{{ .NewestVersion.Chart.Name }}";
var button = document.getElementById("installationForm").elements["submit"];
button.addEventListener("click", installPackage);
  </script>
</html>
